syntax = "proto3";

package chat;

option go_package = "./gen/chatpb";

service ChatService {
  // Bidirectional streaming for real-time messaging
  rpc Connect(stream StreamRequest) returns (stream StreamResponse);
   rpc ListMessages(ListMessagesRequest) returns (ListMessagesResponse);


  // Unary RPCs for channel management
  rpc CreateChannel(CreateChannelRequest) returns (CreateChannelResponse);
  rpc ListChannels(ListChannelsRequest) returns (ListChannelsResponse);
  rpc GetChannel(GetChannelRequest) returns (GetChannelResponse);
  rpc AddMember(AddMemberRequest) returns (AddMemberResponse);
  rpc RemoveMember(RemoveMemberRequest) returns (RemoveMemberResponse);
  rpc ListMembers(ListMembersRequest) returns (ListMembersResponse);
}


// Streaming messages
message StreamRequest {
  oneof payload {
    JoinPayload join = 1;
    MessagePayload message = 2;
  }
}

message JoinPayload {
  string user_id = 1;
  string channel_id = 2;
}


// Request for loading channel history
message ListMessagesRequest {
  string channel_id = 1;
  int64 before_timestamp_ms = 2; // Optional: fetch older messages
  int32 limit = 3;               // Optional: number of messages (default 50)
}

// Single message in history
message MessageInfo {
  string message_id = 1;
  string sender_id = 2;
  string content = 3;
  int64 timestamp_ms = 4;
  string username = 5; // Optional: to avoid extra DB lookup
}

// Response containing messages
message ListMessagesResponse {
  repeated MessageInfo messages = 1;
}




message MessagePayload {
  string user_id = 1;
  string channel_id = 2;
  string content = 3;
}

message StreamResponse {
  string message_id = 1;
  string sender_id = 2;
  string channel_id = 3;
  string content = 4;
  int64 timestamp_ms = 5; // FIXED: Changed from created_at string to timestamp_ms int64
}

// Channel management messages
message CreateChannelRequest {
  string name = 1;
  string creator_id = 2;
}

message CreateChannelResponse {
  string channel_id = 1;
  string name = 2;
  string created_by = 3;
  int64 created_at_ms = 4;
}

message GetChannelRequest {
  string channel_id = 1;
}

message GetChannelResponse {
 ChannelInfo channel = 1;
}

message AddMemberRequest {
  string channel_id = 1;
  string user_id = 2;
}

message AddMemberResponse {
  string member_id = 1;
  string channel_id = 2;
  string user_id = 3;
  int64 joined_at_ms = 4;
}

message RemoveMemberRequest {
  string channel_id = 1;
  string user_id = 2;
}

message RemoveMemberResponse {
  bool success = 1;
}

message ListMembersRequest {
  string channel_id = 1;
}

message ListMembersResponse {
  repeated MemberInfo members = 1;
}

message ListChannelsRequest {
  string user_id = 1;
}

message ListChannelsResponse {
  repeated ChannelInfo channels = 1;
}
message ChannelInfo{
  string channel_id = 1;
  string name = 2;
  string created_by = 3;
  int64 created_at_ms = 4;
  repeated MemberInfo members = 5;
}

message MemberInfo {
  string user_id = 1;
  int64 joined_at_ms = 2;
  string username = 3;

}
