syntax = "proto3";

package auth;

option go_package = "./gen/authpb";

// =============================================================================
// ENUMS
// =============================================================================



enum AuthProvider {
  PROVIDER_EMAIL = 0;
  PROVIDER_GOOGLE = 1;
  PROVIDER_GITHUB = 2;
}

// =============================================================================
// CORE MODELS
// =============================================================================

message User {
  string id = 1;
  string email = 2;
  string username = 3;
  string  role = 4;
  bool is_email_verified = 5;
  string avatar_url = 6;
  bool is_banned = 7;
  bool is_upload_blocked = 8;
  int64 created_at = 9;
  int64 updated_at = 10;
}

message PaginationRequest {
  int32 offset= 1;
  int32 limit = 2;
}



// =============================================================================
// AUTH SERVICE MESSAGES (Public/User)
// =============================================================================

// --- 1. Registration & Login ---

message RegisterRequest {
  string username = 1;
  string email = 2;
  string password = 3;
}

message RegisterResponse {
  bool success = 1;
  string user_id = 2;
}

message LoginRequest {
  string email = 1;
  string password = 2;
}

message LoginResponse {
  User user = 1;
  string access_token = 2;
  string refresh_token = 3;
}

message OAuthLoginRequest {
  AuthProvider provider = 1;
  string oauth_token = 2; // Token from provider (e.g., Google ID token)
}

message OAuthLoginResponse {
  User user = 1;
  string access_token = 2;
  string refresh_token = 3;
}

// --- 2. Magic Link Flow ---

message SendMagicLinkRequest {
  string email = 1;
}

message SendMagicLinkResponse {
  bool success = 1;
  string magic_link_id = 2; // Ops usage, actual link usually sent via email
  int64 expires_at = 3;
}

message VerifyMagicLinkRequest {
  string email = 1;
  string token = 2;
}

message VerifyMagicLinkResponse {
  User user = 1;
  string access_token = 2;
  string refresh_token = 3;
}

// --- 3. Password Management ---

message PasswordResetRequest {
  string email = 1;
}

message PasswordResetResponse {
  bool success = 1;
  string message = 2; // "If email exists, reset link sent"
}

message VerifyPasswordResetRequest {
  string email = 1;
  string token = 2;
  string new_password = 3;
}

message VerifyPasswordResetResponse {
  bool success = 1;
}

message ChangePasswordRequest {
  string user_id = 1;
  string current_password = 2;
  string new_password = 3;
}

message ChangePasswordResponse {
  bool success = 1;
}

// --- 4. Profile & Search ---

message GetUserRequest {
  oneof query {
    string user_id = 1;
    string email = 2;
  }
}

message GetUserResponse {
  User user = 1;
}

message UpdateProfileRequest {
  string user_id = 1;
  string username = 2; // Optional
}

message UpdateProfileResponse {
  User user = 1;
}

message UploadAvatarRequest {
  string user_id = 1;
  bytes file_data = 2;
  string filename = 3;
  string mime_type = 4;
}

message UploadAvatarResponse {
  string avatar_url = 1;
}

message SearchUsersRequest {
  string query = 1; // username or email partial match
  PaginationRequest pagination = 2;
}

message SearchUsersResponse {
  repeated User users = 1;
}

// =============================================================================
// ADMIN SERVICE MESSAGES (Governance)
// =============================================================================

message AdminListUsersRequest {
  string admin_id = 1;
  string filter_query = 2; // Optional filter
  PaginationRequest pagination = 3;
}

message AdminListUsersResponse {
  repeated User users = 1;
}

message AdminUpdateRoleRequest {
  string target_user_id = 1;
  string new_role = 2;
  string admin_id = 3;
}

message AdminUpdateRoleResponse {
  bool success = 1;
}

message AdminBanUserRequest {
  string target_user_id = 1;
  string reason = 2;
  string admin_id = 3;
}

message AdminBanUserResponse {
  bool success = 1;
}

message AdminUnbanUserRequest {
  string target_user_id = 1;
  string reason = 2;
  string admin_id = 3;
}

message AdminUnbanUserResponse {
  bool success = 1;
}

message AdminDeleteUserRequest {
  string target_user_id = 1;
  string admin_id = 2;
}

message AdminDeleteUserResponse {
  bool success = 1;
}

// =============================================================================
// SERVICE DEFINITIONS
// =============================================================================

service AuthService {
  // Authentication
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc OAuthLogin(OAuthLoginRequest) returns (OAuthLoginResponse);

  // Magic Link
  rpc SendMagicLink(SendMagicLinkRequest) returns (SendMagicLinkResponse);
  rpc VerifyMagicLink(VerifyMagicLinkRequest) returns (VerifyMagicLinkResponse);

  // Password Operations
  rpc PasswordReset(PasswordResetRequest) returns (PasswordResetResponse);
  rpc VerifyPasswordReset(VerifyPasswordResetRequest) returns (VerifyPasswordResetResponse);
  rpc ChangePassword(ChangePasswordRequest) returns (ChangePasswordResponse);

  // User Data
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc UpdateProfile(UpdateProfileRequest) returns (UpdateProfileResponse);
  rpc UploadAvatar(UploadAvatarRequest) returns (UploadAvatarResponse);
  rpc SearchUsers(SearchUsersRequest) returns (SearchUsersResponse);
}

service AdminAuthService {
  rpc AdminListUsers(AdminListUsersRequest) returns (AdminListUsersResponse);
  rpc AdminUpdateRole(AdminUpdateRoleRequest) returns (AdminUpdateRoleResponse);
  rpc AdminBanUser(AdminBanUserRequest) returns (AdminBanUserResponse);
  rpc AdminUnbanUser(AdminUnbanUserRequest) returns (AdminUnbanUserResponse);
  rpc AdminDeleteUser(AdminDeleteUserRequest) returns (AdminDeleteUserResponse);
}
