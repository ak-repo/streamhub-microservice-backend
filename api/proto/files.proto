syntax = "proto3";

package files;

option go_package = "./gen/filespb";

// =============================================================================
// SHARED DOMAIN MODELS
// =============================================================================

message FileMetadata {
  string id = 1;
  string owner_id = 2;
  string channel_id = 3;
  string filename = 4;
  int64 size_bytes = 5;
  string mime_type = 6;
  string storage_path = 7;
  bool is_public = 8;
  string created_at = 9; // ISO 8601 string recommended
  string updated_at = 10;
  string ower_name = 11;
  string channelname = 12;
}

message StorageStats {
  int64 total_files_count = 1;
  int64 total_storage_bytes = 2;
  int64 public_files_count = 3;
  int64 private_files_count = 4;
}

// =============================================================================
// USER SERVICE MESSAGES
// =============================================================================

// --- Upload Workflow ---
message CreateUploadUrlRequest {
  string owner_id = 1;
  string channel_id = 2;
  string filename = 3;
  int64 size_bytes = 4;
  string mime_type = 5;
  bool is_public = 6;
}

message CreateUploadUrlResponse {
  string upload_url = 1;
  string file_id = 2;       // Temporary ID until confirmation
  int64 expire_seconds = 3;
}

message CompleteUploadRequest {
  string file_id = 1;
  bool success = 2;         // Client confirms the upload finished
}

message CompleteUploadResponse {
  FileMetadata file = 1;
}

// --- Download Workflow ---
message GetDownloadUrlRequest {
  string file_id = 1;
  string requester_id = 2;
  int64 expire_seconds = 3;
}

message GetDownloadUrlResponse {
  string download_url = 1;
  int64 expire_seconds = 2;
}

// --- File Management ---
message ListFilesRequest {
  string channel_id = 1;
  string requester_id = 2;
  int32 limit = 3;      // Best practice for list endpoints
  int32 offset = 4;
}

message ListFilesResponse {
  repeated FileMetadata files = 1;
}

message DeleteFileRequest {
  string file_id = 1;
  string requester_id = 2;
}

message DeleteFileResponse {
  bool success = 1;
}

message GetStorageUsageRequest {
  string channel_id = 1; // User or Channel ID
}

message GetStorageUsageResponse {
  int64 used_bytes = 1;
  int64 limit_bytes = 2;
}

// =============================================================================
// ADMIN SERVICE MESSAGES
// =============================================================================

message AdminListFilesRequest {
  string admin_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message AdminListFilesResponse {
  repeated FileMetadata files = 1;
}

message AdminDeleteFileRequest {
  string file_id = 1;
  string admin_id = 2;
  bool force_delete = 3; // Skips soft-delete checks
}

message AdminDeleteFileResponse {
  bool success = 1;
}

message AdminSetStorageLimitRequest {
  string target_id = 1;  // User or Channel ID to limit
  int64 max_bytes = 2;
  string admin_id = 3;
}

message AdminSetStorageLimitResponse {
  bool success = 1;
  int64 previous_limit = 2;
}

message AdminBlockUploadsRequest {
  string target_user_id = 1;
  bool block = 2;
  string admin_id = 3;
  string reason = 4;     // For audit logs
}

message AdminBlockUploadsResponse {
  bool success = 1;
}

message AdminGetStatsRequest {
  string admin_id = 1;
}

message AdminGetStatsResponse {
  StorageStats stats = 1;
}

// =============================================================================
// SERVICE DEFINITIONS
// =============================================================================

// Standard service for user-facing file operations
service FileService {
  // Upload Flow
  rpc CreateUploadUrl (CreateUploadUrlRequest) returns (CreateUploadUrlResponse);
  rpc CompleteUpload (CompleteUploadRequest) returns (CompleteUploadResponse);

  // Download Flow
  rpc GetDownloadUrl (GetDownloadUrlRequest) returns (GetDownloadUrlResponse);

  // Management
  rpc ListFiles (ListFilesRequest) returns (ListFilesResponse);
  rpc DeleteFile (DeleteFileRequest) returns (DeleteFileResponse);
  rpc GetStorageUsage (GetStorageUsageRequest) returns (GetStorageUsageResponse);
}

// Dedicated service for administrative operations
service AdminFileService {
  rpc AdminListFiles (AdminListFilesRequest) returns (AdminListFilesResponse);
  rpc AdminDeleteFile (AdminDeleteFileRequest) returns (AdminDeleteFileResponse);
  rpc AdminSetStorageLimit (AdminSetStorageLimitRequest) returns (AdminSetStorageLimitResponse);
  rpc AdminBlockUploads (AdminBlockUploadsRequest) returns (AdminBlockUploadsResponse);
  rpc AdminGetStats (AdminGetStatsRequest) returns (AdminGetStatsResponse);
}
