syntax = "proto3";

package channel;

option go_package = "./gen/channelpb;channelpb";


// =============================================================================
// SHARED DOMAIN MODELS
// =============================================================================

message Channel {
  string id = 1;
  string name = 2;
  string description = 3;
  string visibility = 4;     // <-- string as requested (public/private/secret/etc)
  string owner_id = 5;
  int64 created_at = 6;
  bool is_frozen = 7;
  string owner_name = 8;
  int32 member_count = 9;
}

message ChannelMember {
  string user_id = 1;
  string username = 2;
  string channel_id = 3;
  string role = 4;
  int64 joined_at = 5;
  string id = 6;
}

// Unified model for both "Invites" and "Join Requests"
message MembershipRequest {
  string request_id = 1;
  string user_id = 2;
  string channel_id = 3;
  string type = 4;       
  string status = 5;
  int64 created_at = 6;
}

message ChatMessage {
  string id = 1;
  string channel_id = 2;
  string sender_id = 3;
  string sender_username = 4;
  string content = 5;
  int64 created_at = 6;
}


// =============================================================================
// USER SERVICE MESSAGES
// =============================================================================

// ========== Streaming ==========
message StreamRequest {
  oneof payload {
    StreamConnect connect = 1;
    StreamSendMessage message = 2;
  }
}

message StreamConnect {
  string user_id = 1;
  string channel_id = 2;
}

message StreamSendMessage {
  string content = 1;
}

message StreamResponse {
  string channel_id = 1;
  int64 timestamp = 2;

  oneof event {
    ChatMessage message_created = 3;
  }
}


// ========== Channel CRUD ==========
message CreateChannelRequest {
  string name = 1;
  string description = 2;
  string visibility = 3;  // <-- keep as string
  string creator_id = 4;
}

message CreateChannelResponse {
  Channel channel = 1;
}

message GetChannelRequest {
  string channel_id = 1;
}

message GetChannelResponse {
  Channel channel = 1;
}

message ListUserChannelsRequest {
  string user_id = 1;
}

message ListUserChannelsResponse {
  repeated Channel channels = 1;
}

message DeleteChannelRequest {
  string channel_id = 1;
  string requester_id = 2;
}

message DeleteChannelResponse {
  bool success = 1;
}


// ========== Member Management ==========
message AddMemberRequest {
  string channel_id = 1;
  string user_id = 2;
  string added_by = 3;
}

message AddMemberResponse {
  ChannelMember member = 1;
}

message RemoveMemberRequest {
  string channel_id = 1;
  string user_id = 2;
  string removed_by = 3;
}

message RemoveMemberResponse {
  bool success = 1;
}

message ListMembersRequest {
  string channel_id = 1;
}

message ListMembersResponse {
  repeated ChannelMember members = 1;
}

message PaginationRequest {
  int32 offset= 1;
  int32 limit = 2;
}

message SearchChannelRequest{
  string query = 1;
  PaginationRequest pagination = 2;
}

message SearchChannelResponse{
  repeated Channel channels = 1;
}
// ========== Request Management ==========
message SendInviteRequest {
  string target_user_id = 1;
  string channel_id = 2;
  string sender_id = 3;
}

message SendInviteResponse {
  string request_id = 1;
  bool success = 2;
}

message SendJoinRequest {
  string user_id = 1;
  string channel_id = 2;
}

message SendJoinResponse {
  string request_id = 1;
  string message = 2;
}

message UpdateRequestStatusRequest {
  string request_id = 1;
  string user_id = 2;
  string status = 3;
}

message UpdateRequestStatusResponse {
  bool success = 1;
}

message ListUserInvitesRequest {
  string user_id = 1;
}

message ListUserInvitesResponse {
  repeated MembershipRequest requests = 1;
}

message ListChannelJoinsRequest {
  string channel_id = 1;
}

message ListChannelJoinsResponse {
  repeated MembershipRequest requests = 1;
}


// ========== Chat History ==========
message ListMessagesRequest {
  string channel_id = 1;
PaginationRequest pagination = 2;
}

message ListMessagesResponse {
  repeated ChatMessage messages = 1;
}


// =============================================================================
// ADMIN MESSAGES
// =============================================================================

message ChannelWithMembers{
  Channel channel = 1;
  repeated ChannelMember members = 2;
}
message AdminListChannelsRequest {
  string admin_id = 1;
  int32 limit = 2;
  int32 offset = 3;
}

message AdminListChannelsResponse {
  repeated ChannelWithMembers channels = 1;
}

message AdminFreezeChannelRequest {
  string channel_id = 1;
  string admin_id = 2;
  string reason = 3;
  bool freeze = 4;
}

message AdminFreezeChannelResponse {
  bool success = 1;
}

message AdminDeleteChannelRequest {
  string channel_id = 1;
  string admin_id = 2;
}

message AdminDeleteChannelResponse {
  bool success = 1;
}


// =============================================================================
// SERVICE DEFINITIONS
// =============================================================================

service ChannelService {
  rpc Connect(stream StreamRequest) returns (stream StreamResponse);

  rpc ListMessages(ListMessagesRequest) returns (ListMessagesResponse);

  rpc CreateChannel(CreateChannelRequest) returns (CreateChannelResponse);
  rpc ListUserChannels(ListUserChannelsRequest) returns (ListUserChannelsResponse);
  rpc GetChannel(GetChannelRequest) returns (GetChannelResponse);
  rpc DeleteChannel(DeleteChannelRequest) returns (DeleteChannelResponse);

  rpc AddMember(AddMemberRequest) returns (AddMemberResponse);
  rpc RemoveMember(RemoveMemberRequest) returns (RemoveMemberResponse);
  rpc ListMembers(ListMembersRequest) returns (ListMembersResponse);

  rpc SendInvite(SendInviteRequest) returns (SendInviteResponse);
  rpc SendJoin(SendJoinRequest) returns (SendJoinResponse);
  rpc UpdateRequestStatus(UpdateRequestStatusRequest) returns (UpdateRequestStatusResponse);
  rpc SearchChannels(SearchChannelRequest)returns(SearchChannelResponse);

  rpc ListUserInvites(ListUserInvitesRequest) returns (ListUserInvitesResponse);
  rpc ListChannelJoins(ListChannelJoinsRequest) returns (ListChannelJoinsResponse);


  // other services calls
  rpc UpdateUsedMB(UpdateUsedMBRequest)returns (UpdateUsedMBResponse);
  rpc UpdateChannelPlan(ChannelPlanRequest)returns(ChannelPlanResponse);
    rpc GetChannelStorage (GetStorageUsageRequest) returns (GetStorageUsageResponse);
}

message GetStorageUsageRequest {
  string channel_id = 1; 
  string requester_id = 2;

}

message GetStorageUsageResponse {
  int64 used_bytes = 1;
  int64 limit_bytes = 2;
}

message ChannelPlanRequest{
  string channel_id = 1;
  string plan_id = 2;
  int64 limit_bytes = 3;
}
message ChannelPlanResponse{
  bool success = 1;
}

message UpdateUsedMBRequest{
  string channel_id = 1;
  int64 used_bytes = 2;
}

message UpdateUsedMBResponse{
  bool success = 1;
}


service AdminChannelService {
  rpc AdminListChannels(AdminListChannelsRequest) returns (AdminListChannelsResponse);
  rpc AdminFreezeChannel(AdminFreezeChannelRequest) returns (AdminFreezeChannelResponse);
  rpc AdminDeleteChannel(AdminDeleteChannelRequest) returns (AdminDeleteChannelResponse);
}



//TODO , 
//update plan and limit when payment success, 
// update used mp when new file added or deleted file

